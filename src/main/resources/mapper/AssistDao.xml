<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.dao.AssistDao">

    <!--插入咨询记录-->
    <insert id="insertAssist" parameterType="com.example.demo.domain.Assist">
        insert into assist(c_username, s_username, c_name, s_name, duration, startDate) values (#{c_username}, #{s_username}, #{c_name}, #{s_name}, #{duration}, #{startDate})
    </insert>

    <!--返回所有求助记录-->
    <select id="findAllAssist" resultType="com.example.demo.domain.Assist">
        select * from assist ORDER BY startDate DESC limit #{pageNum}, #{pageSize}
    </select>
    <select id="totalAll" resultType="long">
        select count(*) from assist
    </select>
    <!--通过咨询师姓名查找求助记录-->
    <select id="findAllAssistByConName" resultType="com.example.demo.domain.Assist">
        select * from assist where c_name = #{counselorName} ORDER BY startDate DESC limit #{pageNum}, #{pageSize}
    </select>
    <select id="totalByConName" resultType="long">
        select count(*) from assist where c_name = #{counselorName}
    </select>
    <!--通过督导姓名查询求助记录-->
    <select id="通过督导姓名查询求助记录" resultType="com.example.demo.domain.Assist">
        select * from assist where s_name = #{supervisorName} ORDER BY startDate DESC limit #{pageNum}, #{pageSize}
    </select>
    <!--通过时间查询求助记录-->
    <select id="findAllAssistByTime" resultType="com.example.demo.domain.Assist">
        select * from assist where startDate between #{startDate} and #{endDate} ORDER BY startDate DESC limit #{pageNum}, #{pageSize}
    </select>
    <select id="totalByTime" resultType="long">
        select count(*) from assist where startDate between #{startDate} and #{endDate}
    </select>
    <!--通过所有条件查询求助记录-->
    <select id="findAllAssistByAll" resultType="com.example.demo.domain.Assist">
        select * from assist where c_name = #{counselorName} and startDate between #{startDate} and #{endDate} ORDER BY startDate DESC limit #{pageNum}, #{pageSize}
    </select>
    <select id="totalByAll" resultType="long">
        select count(*) from assist where c_name = #{counselorName} and startDate between #{startDate} and #{endDate}
    </select>


    <!--获得绑定的所有咨询师的username-->
    <select id="findAllBindByUsername" parameterType="String" resultType="String">
        select username from worker where bind_username = #{supervisorUsername}
    </select>

    <!--获得绑定的所有咨询师的所有求助记录-->
    <select id="findAllBindAssist" resultType="com.example.demo.domain.Assist">
        select * from assist where s_username = #{supervisorUsername} ORDER BY startDate DESC limit #{pageNum}, #{pageSize}
    </select>

    <!--通过绑定的咨询师姓名查询求助记录-->
    <select id="findAllBindAssistByConName" resultType="com.example.demo.domain.Assist">
        select * from assist
        <where>  <if test="list != null and list.size() > 0">
        AND c_username in <foreach collection="list" item="counselorUsername" open="(" separator="," close=")">
                            #{counselorUsername}</foreach>
         </if> and c_name = #{counselorName}
        </where> ORDER BY startDate DESC
    </select>

    <!--通过时间查询绑定的咨询师的求助记录-->
    <select id="findAllBindAssistByTime" resultType="com.example.demo.domain.Assist">
        select * from assist
        <where>
            <if test="list != null and list.size() > 0">
                AND c_username in <foreach collection="list" item="counselorUsername" open="(" separator="," close=")">
                #{counselorUsername}
            </foreach>
            </if> and startDate between #{startDate} and #{endDate}
        </where> ORDER BY startDate DESC
    </select>

    <!--通过所有条件查询绑定咨询师的求助记录-->
    <select id="findAllBindAssistByAll" resultType="com.example.demo.domain.Assist">
        select * from assist
        <where>
            <if test="list != null and list.size() > 0">
                AND c_username in <foreach collection="list" item="counselorUsername" open="(" separator="," close=")">
                #{counselorUsername}
            </foreach>
            </if> and c_name = #{counselorName} and startDate between #{startDate} and #{endDate}
        </where> ORDER BY startDate DESC
    </select>

    <!--统计某督导一天响应求助的总时长-->
    <select id="supervisorTodayTotalTime" resultType="java.sql.Time">
        select SEC_TO_TIME(sum(TIME_TO_SEC(duration))) from assist where s_username = #{supervisorUsername} and startDate > #{currentDate}
    </select>

    <!--统计某督导当天响应求助的次数-->
    <select id="supervisorTodayAssistCount" parameterType="String" resultType="int">
        select count(*) from assist where s_username = #{supervisorUsername} and startDate > #{currentDate}
    </select>

    <!--最近的响应求助记录-->
    <select id="currentAssist" resultType="com.example.demo.domain.Assist">
        select * from assist where s_username = #{username} ORDER BY startDate DESC limit #{limit}
    </select>
</mapper>